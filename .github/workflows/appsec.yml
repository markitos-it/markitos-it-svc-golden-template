#:[.'.]:>- ===================================================================================
#:[.'.]:>- Marco Antonio - markitos devsecops kulture
#:[.'.]:>- The Way of the Artisan
#:[.'.]:>- markitos.es.info@gmail.com
#:[.'.]:>- 游깴 https://github.com/orgs/markitos-it/repositories
#:[.'.]:>- 游깴 https://github.com/orgs/markitos-public/repositories
#:[.'.]:>- 游닠 https://www.youtube.com/@markitos_devsecops
#:[.'.]:>- ===================================================================================

name: appsec-pipeline

#:[.'.]:>- Evento de ejecuci칩n:
#:[.'.]:>- - push: dispara este pipeline 칰nicamente al hacer push a cualquier rama.
#:[.'.]:>- Opciones posibles en GitHub Actions:
#:[.'.]:>- - pull_request: escanear en PRs.
#:[.'.]:>- - workflow_dispatch: ejecuci칩n manual desde UI.
#:[.'.]:>- - schedule: ejecuci칩n por cron.
on:
  push:

#:[.'.]:>- Permisos m칤nimos para seguridad:
#:[.'.]:>- - contents: read permite leer el repositorio.
#:[.'.]:>- Opciones comunes:
#:[.'.]:>- - security-events: write (si subes SARIF a Code Scanning).
#:[.'.]:>- - packages: read (si necesitas tirar im치genes privadas).
permissions:
  contents: read

jobs:
  scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    concurrency:
      #:[.'.]:>- Evita ejecuciones duplicadas por rama/ref y cancela la anterior en curso.
      #:[.'.]:>- Opciones:
      #:[.'.]:>- - cancel-in-progress: true|false
      #:[.'.]:>- - group: puede incluir workflow + ref para granularidad.
      group: appsec-${{ github.ref }}
      cancel-in-progress: true
    steps:
      #:[.'.]:>- Checkout del c칩digo para que Gitleaks pueda inspeccionar el repo completo.
      #:[.'.]:>- fetch-depth: 0 trae todo el historial.
      #:[.'.]:>- Opciones:
      #:[.'.]:>- - fetch-depth: 1 (r치pido, solo 칰ltimo commit).
      #:[.'.]:>- - persist-credentials: false (recomendado para endurecer).
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      #:[.'.]:>- Escaneo de secretos con Gitleaks v칤a contenedor.
      #:[.'.]:>- --rm: elimina el contenedor al terminar.
      #:[.'.]:>- -v "workspace:/repo": monta el repo para escaneo.
      #:[.'.]:>- detect: modo de detecci칩n de leaks.
      #:[.'.]:>- --source="/repo": ruta objetivo.
      #:[.'.]:>- --redact: enmascara secretos en salida.
      #:[.'.]:>- --no-banner: salida m치s limpia para CI.
      #:[.'.]:>- Opciones 칰tiles:
      #:[.'.]:>- - --verbose: m치s detalle en logs.
      #:[.'.]:>- - --exit-code 1: fuerza fallo cuando encuentra leaks.
      #:[.'.]:>- - --config /repo/.gitleaks.toml: reglas personalizadas.
      #:[.'.]:>- - usar imagen versionada o digest en vez de latest.
      - name: Gitleaks Scan
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/repo" \
            ghcr.io/gitleaks/gitleaks:latest \
            detect --source="/repo" --redact --no-banner

  sast:
    name: SAST Analysis
    runs-on: ubuntu-latest
    concurrency:
      group: sast-${{ github.ref }}
      cancel-in-progress: true
    #:[.'.]:>- Permisos para an치lisis SAST.
    #:[.'.]:>- Opciones:
    #:[.'.]:>- - contents: read (leer c칩digo).
    permissions:
      contents: read
    steps:
      #:[.'.]:>- Checkout del c칩digo para an치lisis SAST.
      - name: Checkout Code
        uses: actions/checkout@v4

      #:[.'.]:>- An치lisis SAST con Semgrep (open source).
      #:[.'.]:>- Escanea el c칩digo en busca de vulnerabilidades y malas pr치cticas.
      #:[.'.]:>- Opciones:
      #:[.'.]:>- - publishToken: para subir resultados a Semgrep Cloud (opcional).
      #:[.'.]:>- - config: auto usa reglas recomendadas, tambi칠n puedes usar:
      #:[.'.]:>-   * p/security-audit: reglas de seguridad.
      #:[.'.]:>-   * p/owasp-top-ten: OWASP Top 10.
      #:[.'.]:>-   * p/ci: r치pido para CI/CD.
      #:[.'.]:>-   * archivo local .semgrep.yml para reglas custom.
      #:[.'.]:>- Nota: Resultados visibles en logs del workflow.
      - name: Semgrep Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

  dependencies:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    concurrency:
      group: deps-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    steps:
      #:[.'.]:>- Checkout del c칩digo.
      - name: Checkout Code
        uses: actions/checkout@v4

      #:[.'.]:>- Escaneo de vulnerabilidades en dependencias con Trivy (Aquasec).
      #:[.'.]:>- Herramienta madura, open source, sin registro requerido.
      #:[.'.]:>- Escanea: pip, npm, gem, maven, gradle, nuget, composer, etc.
      #:[.'.]:>- Opciones:
      #:[.'.]:>- - --severity MEDIUM,HIGH,CRITICAL: filtra por nivel m칤nimo.
      #:[.'.]:>- - --scanners vuln: solo escanea vulnerabilidades.
      #:[.'.]:>- - --exit-code 0: no falla aunque encuentre vulnerabilidades.
      #:[.'.]:>- Nota: Resultados visibles en logs del workflow.
      - name: Trivy Dependency Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "MEDIUM,HIGH,CRITICAL"
          format: "table"
          exit-code: "0"

  infrastructure:
    name: Infrastructure as Code Scanning
    runs-on: ubuntu-latest
    concurrency:
      group: iac-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    steps:
      #:[.'.]:>- Checkout del c칩digo.
      - name: Checkout Code
        uses: actions/checkout@v4

      #:[.'.]:>- Escaneo de misconfigurations IaC con Checkov (Bridgecrew).
      #:[.'.]:>- Herramienta madura, open source, sin registro requerido.
      #:[.'.]:>- Escanea: Terraform, CloudFormation, Kubernetes, Docker, etc.
      #:[.'.]:>- Opciones:
      #:[.'.]:>- - --quiet: salida m칤nima.
      #:[.'.]:>- - --compact: formato compacto.
      #:[.'.]:>- - --framework: especifica frameworks (terraform, k8s, dockerfile, etc).
      #:[.'.]:>- Nota: Resultados visibles en logs del workflow.
      - name: Checkov IaC Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          quiet: true
          compact: true
          framework: all
          output_format: cli

  linting:
    name: Bash Linting
    runs-on: ubuntu-latest
    concurrency:
      group: lint-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    steps:
      #:[.'.]:>- Checkout del c칩digo.
      - name: Checkout Code
        uses: actions/checkout@v4

      #:[.'.]:>- Linting de scripts Bash con ShellCheck.
      #:[.'.]:>- Detecta bugs, c칩digo inseguro, estilo poor en bash.
      #:[.'.]:>- Opciones:
      #:[.'.]:>- find: localiza todos los archivos .sh.
      #:[.'.]:>- --severity=style: nivel m칤nimo de severidad.
      #:[.'.]:>- --exclude=SC1090: excluye la regla SC1090 (source path not found).
      #:[.'.]:>- Nota: Resultados visibles en logs del workflow.
      - name: ShellCheck Scan
        shell: bash
        run: |
          sudo apt-get install -y shellcheck
          find . -type f -name "*.sh" -not -path "*/alias/*" -print0 | xargs -0 shellcheck --severity=style --shell=bash --exclude=SC1090 || true
